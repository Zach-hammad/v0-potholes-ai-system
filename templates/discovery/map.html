{% extends "base.html" %}

{% block title %}Incident Map - {{ app_name }}{% endblock %}

{% block content %}
<div class="container-fluid p-0">
    <!-- Map Header -->
    <div class="bg-primary text-white py-3">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h1 class="h3 mb-0">
                        <i class="fas fa-map me-2"></i>Incident Map
                    </h1>
                    <p class="mb-0 opacity-75">Real-time view of reported potholes</p>
                </div>
                <div class="col-md-6 text-md-end">
                    <div class="btn-group" role="group">
                        <a href="{{ url_for('discovery.index') }}" class="btn btn-outline-light">
                            <i class="fas fa-home me-1"></i>Home
                        </a>
                        <a href="{{ url_for('discovery.report_incident') }}" class="btn btn-light">
                            <i class="fas fa-plus me-1"></i>Report Issue
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Map Filters -->
    <div class="bg-light border-bottom py-3">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <div class="d-flex gap-3 flex-wrap">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="showCritical" checked>
                            <label class="form-check-label text-danger fw-bold" for="showCritical">
                                Critical
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="showMajor" checked>
                            <label class="form-check-label text-warning fw-bold" for="showMajor">
                                Major
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="showModerate" checked>
                            <label class="form-check-label text-info" for="showModerate">
                                Moderate
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="showMinor" checked>
                            <label class="form-check-label text-secondary" for="showMinor">
                                Minor
                            </label>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 text-md-end">
                    <span class="text-muted">
                        <i class="fas fa-map-marker-alt me-1"></i>
                        {{ incidents|length }} incidents shown
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- Full Screen Map -->
    <div style="height: calc(100vh - 200px);" id="fullMap"></div>

    <!-- Map Legend -->
    <div class="bg-white border-top py-3">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <h6 class="mb-3">Legend</h6>
                    <div class="d-flex gap-4 flex-wrap">
                        <div class="d-flex align-items-center">
                            <div class="bg-danger rounded-circle me-2" style="width: 12px; height: 12px;"></div>
                            <small>Critical - Immediate attention required</small>
                        </div>
                        <div class="d-flex align-items-center">
                            <div class="bg-warning rounded-circle me-2" style="width: 12px; height: 12px;"></div>
                            <small>Major - Significant road damage</small>
                        </div>
                        <div class="d-flex align-items-center">
                            <div class="bg-info rounded-circle me-2" style="width: 12px; height: 12px;"></div>
                            <small>Moderate - Noticeable but manageable</small>
                        </div>
                        <div class="d-flex align-items-center">
                            <div class="bg-secondary rounded-circle me-2" style="width: 12px; height: 12px;"></div>
                            <small>Minor - Small surface issues</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const incidents = {{ incidents | tojson }};
    
    // Initialize full-screen map
    const map = L.map('fullMap').setView([40.7128, -74.0060], 10);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);
    
    // Color mapping for severity
    const severityColors = {
        'critical': '#ef4444',
        'major': '#f59e0b',
        'moderate': '#06b6d4',
        'minor': '#64748b'
    };
    
    // Add markers for each incident
    const markers = {};
    incidents.forEach(incident => {
        if (incident.latitude && incident.longitude) {
            const color = severityColors[incident.severity] || '#64748b';
            
            const marker = L.circleMarker([incident.latitude, incident.longitude], {
                color: color,
                fillColor: color,
                fillOpacity: 0.7,
                radius: incident.severity === 'critical' ? 10 : 
                       incident.severity === 'major' ? 8 : 
                       incident.severity === 'moderate' ? 6 : 4
            }).addTo(map);
            
            const popupContent = `
                <div class="p-2">
                    <h6 class="mb-2">${incident.location}</h6>
                    <p class="mb-1">
                        <strong>Severity:</strong> 
                        <span class="severity-${incident.severity}">${incident.severity}</span>
                    </p>
                    <p class="mb-1">
                        <strong>Status:</strong> 
                        <span class="badge status-${incident.status}">${incident.status}</span>
                    </p>
                    <p class="mb-0 text-muted small">
                        <i class="fas fa-clock me-1"></i>
                        ${new Date(incident.created_at).toLocaleDateString()}
                    </p>
                </div>
            `;
            
            marker.bindPopup(popupContent);
            markers[incident.severity] = markers[incident.severity] || [];
            markers[incident.severity].push(marker);
        }
    });
    
    // Filter functionality
    const filterCheckboxes = document.querySelectorAll('input[type="checkbox"][id^="show"]');
    filterCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const severity = this.id.replace('show', '').toLowerCase();
            const severityMarkers = markers[severity] || [];
            
            severityMarkers.forEach(marker => {
                if (this.checked) {
                    map.addLayer(marker);
                } else {
                    map.removeLayer(marker);
                }
            });
        });
    });
    
    // Fit map to show all markers
    if (incidents.length > 0) {
        const group = new L.featureGroup(Object.values(markers).flat());
        map.fitBounds(group.getBounds().pad(0.1));
    }
});
</script>
{% endblock %}
